package io.choerodon.devops.api.controller.v1;

import java.util.*;
import javax.validation.Valid;

import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.hzero.core.util.Results;
import org.hzero.starter.keyencrypt.core.Encrypt;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import springfox.documentation.annotations.ApiIgnore;

import io.choerodon.core.domain.Page;
import io.choerodon.core.exception.CommonException;
import io.choerodon.core.iam.InitRoleCode;
import io.choerodon.core.iam.ResourceLevel;
import io.choerodon.devops.api.validator.DevopsCiPipelineAdditionalValidator;
import io.choerodon.devops.api.vo.*;
import io.choerodon.devops.api.vo.pipeline.ExecuteTimeVO;
import io.choerodon.devops.app.service.CiCdPipelineRecordService;
import io.choerodon.devops.app.service.DevopsCdJobService;
import io.choerodon.devops.app.service.DevopsCiPipelineService;
import io.choerodon.devops.infra.dto.CiCdPipelineDTO;
import io.choerodon.devops.infra.dto.DevopsCiPipelineFunctionDTO;
import io.choerodon.mybatis.pagehelper.annotation.SortDefault;
import io.choerodon.mybatis.pagehelper.domain.PageRequest;
import io.choerodon.mybatis.pagehelper.domain.Sort;
import io.choerodon.swagger.annotation.CustomPageRequest;
import io.choerodon.swagger.annotation.Permission;

/**
 * 〈功能简述〉
 * 〈CI流水线Controller〉
 *
 * @author wanghao
 * @Date 2020/4/2 17:57
 */
@RestController
@RequestMapping("/v1/projects/{project_id}/cicd_pipelines")
public class CiCdPipelineController {

    @Autowired
    private DevopsCiPipelineService devopsCiPipelineService;
    @Autowired
    private CiCdPipelineRecordService ciCdPipelineRecordService;
    @Autowired
    private DevopsCdJobService devopsCdJobService;

    @Permission(level = ResourceLevel.ORGANIZATION, roles = {InitRoleCode.PROJECT_OWNER, InitRoleCode.PROJECT_MEMBER})
    @ApiOperation(value = "项目下创建流水线")
    @PostMapping
    public ResponseEntity<CiCdPipelineDTO> create(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @RequestBody @Valid CiCdPipelineVO ciCdPipelineVO) {
        DevopsCiPipelineAdditionalValidator.additionalCheckPipeline(ciCdPipelineVO);
        DevopsCiPipelineAdditionalValidator.validateBranch(ciCdPipelineVO.getRelatedBranches());
        return ResponseEntity.ok(devopsCiPipelineService.create(projectId, ciCdPipelineVO));
    }

    @Permission(level = ResourceLevel.ORGANIZATION, roles = {InitRoleCode.PROJECT_OWNER, InitRoleCode.PROJECT_MEMBER})
    @ApiOperation(value = "项目下更新流水线")
    @PutMapping("/{pipeline_id}")
    public ResponseEntity<CiCdPipelineDTO> update(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true)
            @ApiParam(value = "流水线Id", required = true)
            @PathVariable(value = "pipeline_id") Long pipelineId,
            @RequestBody @Valid CiCdPipelineVO ciCdPipelineVO) {
        DevopsCiPipelineAdditionalValidator.additionalCheckPipeline(ciCdPipelineVO);
        return ResponseEntity.ok(devopsCiPipelineService.update(projectId, pipelineId, ciCdPipelineVO));
    }

    @Permission(level = ResourceLevel.ORGANIZATION, roles = {InitRoleCode.PROJECT_OWNER, InitRoleCode.PROJECT_MEMBER})
    @ApiOperation(value = "查询cicd流水线配置")
    @GetMapping("/{pipeline_id}")
    public ResponseEntity<CiCdPipelineVO> query(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true)
            @ApiParam(value = "流水线Id", required = true)
            @PathVariable(value = "pipeline_id") Long pipelineId) {
        return ResponseEntity.ok(devopsCiPipelineService.query(projectId, pipelineId));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "查询cicd流水线基础配置")
    @GetMapping("/{pipeline_id}/basic_info")
    public ResponseEntity<CiCdPipelineVO> queryBasicInfoById(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true)
            @ApiParam(value = "流水线Id", required = true)
            @PathVariable(value = "pipeline_id") Long pipelineId) {
        return ResponseEntity.ok(devopsCiPipelineService.queryById(pipelineId));
    }


    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "查询项目下流水线")
    @PostMapping("/query")
    @CustomPageRequest
    public ResponseEntity<Page<CiCdPipelineVO>> listByProjectIdAndAppName(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @RequestParam(value = "searchParam", required = false) String searchParam,
            @ApiParam(value = "是否启用")
            @RequestParam(value = "enableFlag", required = false) Boolean enableFlag,
            @ApiParam(value = "最近执行状态")
            @RequestParam(value = "status", required = false) String status,
            @ApiParam(value = "分页参数")
            @ApiIgnore PageRequest pageRequest) {
        return ResponseEntity.ok(devopsCiPipelineService.listByProjectIdAndAppName(projectId, searchParam, pageRequest, enableFlag, status));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "停用流水线")
    @PutMapping("/{pipeline_id}/disable")
    public ResponseEntity<CiCdPipelineDTO> disablePipeline(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true)
            @PathVariable(value = "pipeline_id") Long pipelineId) {
        return ResponseEntity.ok(devopsCiPipelineService.disablePipeline(projectId, pipelineId));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "启用流水线")
    @PutMapping("/{pipeline_id}/enable")
    public ResponseEntity<CiCdPipelineDTO> enablePipeline(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true)
            @PathVariable(value = "pipeline_id") Long pipelineId) {
        return ResponseEntity.ok(devopsCiPipelineService.enablePipeline(projectId, pipelineId));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "删除流水线")
    @DeleteMapping("/{pipeline_id}")
    public ResponseEntity<Void> deletePipeline(
            @ApiParam(value = "项目Id", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true)
            @PathVariable(value = "pipeline_id") Long pipelineId) {
        devopsCiPipelineService.deletePipeline(projectId, pipelineId);
        return ResponseEntity.noContent().build();
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "全新执行GitLab流水线")
    @PostMapping(value = "/{pipeline_id}/execute")
    public ResponseEntity<Boolean> executeNew(
            @Encrypt(ignoreUserConflict = true)
            @PathVariable(value = "pipeline_id") Long pipelineId,
            @ApiParam(value = "项目ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @RequestParam(value = "gitlab_project_id") Long gitlabProjectId,
            @ApiParam(value = "分支名", required = true)
            @RequestParam(value = "ref") String ref,
            @RequestParam(value = "tag", defaultValue = "false") Boolean tag,
            @RequestBody Map<String, String> variables) {
        DevopsCiPipelineAdditionalValidator.additionalCheckVariablesKey(variables);
        ciCdPipelineRecordService.executeNew(projectId, pipelineId, gitlabProjectId, ref, tag, variables);
        return ResponseEntity.noContent().build();
    }


//    @Permission(level = ResourceLevel.ORGANIZATION)
//    @ApiOperation(value = "测试主机连接")
//    @PostMapping(value = "/test_connection")
//    public ResponseEntity<Boolean> testConnection(
//            @ApiParam(value = "项目ID", required = true)
//            @PathVariable(value = "project_id") Long projectId,
//            @RequestBody HostConnectionVO hostConnectionVO) {
//        return Results.success(devopsCdPipelineRecordService.testConnection(hostConnectionVO));
//    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "devops图表，查询项目下流水线名称")
    @GetMapping(value = "/devops/pipeline")
    public ResponseEntity<List<CiCdPipelineDTO>> devopsPipline(
            @ApiParam(value = "项目ID", required = true)
            @PathVariable(value = "project_id") Long projectId) {
        return Results.success(devopsCiPipelineService.devopsPipline(projectId));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "devops图表 获取流水触发次数报表")
    @GetMapping(value = "/trigger")
    public ResponseEntity<PipelineFrequencyVO> listPipelineTrigger(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt
            @ApiParam(value = "pipeline_id")
            @RequestParam(value = "pipeline_id", required = false) Long pipelineId,
            @ApiParam(value = "start_time")
            @RequestParam(value = "start_time") Date startTime,
            @ApiParam(value = "end_time")
            @RequestParam(value = "end_time") Date endTime) {
        return Optional.ofNullable(devopsCiPipelineService.listPipelineTrigger(pipelineId, startTime, endTime))
                .map(target -> new ResponseEntity<>(target, HttpStatus.OK))
                .orElseThrow(() -> new CommonException("error.pipeline.trigger.get"));
    }


    @Permission(level = ResourceLevel.ORGANIZATION,
            roles = {InitRoleCode.PROJECT_OWNER,
                    InitRoleCode.PROJECT_MEMBER})
    @ApiOperation(value = "devops图表 项目下分页查询流水线按触发记录")
    @GetMapping(value = "/trigger/page")
    @CustomPageRequest
    public ResponseEntity<Page<CiCdPipelineRecordVO>> pagePipelineTrigger(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt
            @ApiParam(value = "pipeline_id")
            @RequestParam(value = "pipeline_id", required = false) Long pipelineId,
            @ApiParam(value = "start_time")
            @RequestParam(value = "start_time") Date startTime,
            @ApiParam(value = "end_time")
            @RequestParam(value = "end_time") Date endTime,
            @ApiParam(value = "分页参数")
            @SortDefault(value = "id", direction = Sort.Direction.DESC) PageRequest pageRequest) {
        return Optional.ofNullable(devopsCiPipelineService.pagePipelineTrigger(pipelineId, startTime, endTime, pageRequest))
                .map(target -> new ResponseEntity<>(target, HttpStatus.OK))
                .orElseThrow(() -> new CommonException("error.pipeline.trigger.page.get"));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "devops图表 流水线执行时长图（根据流水线列表，时间）")
    @PostMapping(value = "/execute/time")
    public ResponseEntity<ExecuteTimeVO> pipelineExecuteTime(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt
            @ApiParam(value = "pipeline_ids")
            @RequestBody(required = true) List<Long> pipelineIds,
            @ApiParam(value = "start_time")
            @RequestParam(value = "start_time") Date startTime,
            @ApiParam(value = "end_time")
            @RequestParam(value = "end_time") Date endTime) {
        return ResponseEntity.ok(devopsCiPipelineService.pipelineExecuteTime(pipelineIds, startTime, endTime));
    }

    @Permission(level = ResourceLevel.ORGANIZATION,
            roles = {InitRoleCode.PROJECT_OWNER,
                    InitRoleCode.PROJECT_MEMBER})
    @ApiOperation(value = "devops图表 流水线执行时长图表格查询")
    @PostMapping(value = "/execute/time/page")
    public ResponseEntity<Page<CiCdPipelineRecordVO>> pagePipelineExecuteTime(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt
            @ApiParam(value = "pipeline_ids")
            @RequestBody(required = true) List<Long> pipelineIds,
            @ApiParam(value = "start_time")
            @RequestParam(value = "start_time") Date startTime,
            @ApiParam(value = "end_time")
            @RequestParam(value = "end_time") Date endTime,
            @ApiParam(value = "分页参数")
            @SortDefault(value = "id", direction = Sort.Direction.DESC) PageRequest pageRequest) {
        return Optional.ofNullable(devopsCiPipelineService.pagePipelineExecuteTime(pipelineIds, startTime, endTime, pageRequest))
                .map(target -> new ResponseEntity<>(target, HttpStatus.OK))
                .orElseThrow(() -> new CommonException("error.pipeline.execute.time.get"));
    }


    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "查询runner指引需要的参数")
    @GetMapping(value = "/runner_guide")
    public ResponseEntity<Map<String, String>> runnerGuide(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId) {
        return Optional.ofNullable(devopsCiPipelineService.runnerGuide(projectId))
                .map(target -> new ResponseEntity<>(target, HttpStatus.OK))
                .orElseThrow(() -> new CommonException("error.pipeline.execute.time.get"));
    }

    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "批量查询测试任务关联的流水线")
    @PostMapping(value = "/list_task_pipeline_referrance")
    public ResponseEntity<List<PipelineInstanceReferenceVO>> listTaskReferencePipelineInfo(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt
            @ApiParam(value = "API测试任务id", required = true)
            @RequestBody Set<Long> taskIds) {
        return ResponseEntity.ok(devopsCiPipelineService.listTaskReferencePipelineInfo(projectId, taskIds));
    }

    @Permission(level = ResourceLevel.ORGANIZATION, permissionWithin = true)
    @ApiOperation(value = "列出所有任务配置关联的流水线名称")
    @GetMapping(value = "/list_pipeline_name_reference_by_config_id")
    public ResponseEntity<List<String>> listPipelineNameReferenceByConfigId(@ApiParam(value = "项目 ID", required = true)
                                                                            @PathVariable(value = "project_id") Long projectId,
                                                                            @ApiParam(value = "API测试任务配置ID", required = true)
                                                                            @RequestParam("config_id") Long taskConfigId) {
        return Results.success(devopsCiPipelineService.listPipelineNameReferenceByConfigId(projectId, taskConfigId));
    }


    @Permission(level = ResourceLevel.ORGANIZATION)
    @ApiOperation(value = "查询流水线下定义的函数")
    @PostMapping(value = "/{pipeline_id}/functions")
    public ResponseEntity<List<DevopsCiPipelineFunctionDTO>> listFunctionsByDevopsPipelineId(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId,
            @Encrypt(ignoreUserConflict = true, ignoreValue = {"0"})
            @PathVariable(value = "pipeline_id") Long pipelineId,
            @RequestParam(value = "include_default", defaultValue = "false") Boolean includeDefault) {
        return ResponseEntity.ok(devopsCiPipelineService.listFunctionsByDevopsPipelineId(projectId, pipelineId, includeDefault));
    }

    @ApiOperation(value = "修复数据使用，查询所有apiTest类型的数据", hidden = true)
    @Permission(level = ResourceLevel.ORGANIZATION, permissionWithin = true)
    @GetMapping("/api_test/list")
    public ResponseEntity<List<CdApiTestConfigForSagaVO>> listCdApiTestConfig(
            @ApiParam(value = "项目 ID", required = true)
            @PathVariable(value = "project_id") Long projectId) {
        return Results.success(devopsCdJobService.listCdApiTestConfig());
    }

}
