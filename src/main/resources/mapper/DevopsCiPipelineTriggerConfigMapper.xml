<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.choerodon.devops.infra.mapper.DevopsCiPipelineTriggerConfigMapper">
  <select id="queryGitlabProjectId" resultType="io.choerodon.devops.infra.dto.DevopsCiPipelineTriggerConfigDTO">
    SELECT dcptc.id,
    dcptc.trigger_pipeline_gitlab_project_id,
    dcptc.last_updated_by
    FROM devops_ci_pipeline_trigger_config dcptc
    JOIN devops_cicd_pipeline dcp ON dcp.id = dcptc.pipeline_id
    JOIN devops_app_service das ON das.id = dcp.app_service_id
    WHERE dcptc.id = #{configId}
    AND das.token = #{token}
  </select>

  <select id="listByJobIds" resultType="io.choerodon.devops.infra.dto.DevopsCiPipelineTriggerConfigDTO">
    SELECT dcptc.id,
    dcptc.triggered_pipeline_gitlab_project_id,
    dcptc.pipeline_trigger_id
    FROM devops_ci_pipeline_trigger_config dcptc
    JOIN devops_ci_job dcj ON dcj.config_id = dcptc.id AND dcj.type = 'pipeline_trigger'
    WHERE dcj.id IN
    <foreach collection="jobIds" separator="," open="(" close=")" item="jobId">
      #{jobId}
    </foreach>
  </select>

  <delete id="deleteByIds">
    DELETE FROM devops_ci_pipeline_trigger_config
    WHERE id IN
    <foreach collection="ids" separator="," open="(" close=")" item="id">
      #{id}
    </foreach>
  </delete>
</mapper>