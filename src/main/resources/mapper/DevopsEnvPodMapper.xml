<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="io.choerodon.devops.infra.mapper.DevopsEnvPodMapper">
    <sql id="sqlparam">
        <if test='searchParam != null'>
            <if test='searchParam.name != null and searchParam.name.length > 0'>
                AND
                dp.`name` LIKE CONCAT(CONCAT('%', #{searchParam.name, jdbcType=VARCHAR}),'%')
            </if>
            <if test='searchParam.appServiceService != null and searchParam.appServiceService.length > 0'>
                AND
                dav.version LIKE CONCAT(CONCAT('%', #{searchParam.appServiceService, jdbcType=VARCHAR}),'%')
            </if>
            <if test='searchParam.ip != null and searchParam.ip.length > 0'>
                AND
                dp.ip LIKE CONCAT(CONCAT('%', #{searchParam.ip, jdbcType=VARCHAR}),'%')
            </if>
            <if test='searchParam.ready != null and searchParam.ready.length > 0'>
                AND dp.is_ready = #{searchParam.ready}
            </if>
            <if test='searchParam.instanceCode != null and searchParam.instanceCode.length > 0'>
                AND
                dai.`code` LIKE CONCAT(CONCAT('%', #{searchParam.instanceCode, jdbcType=VARCHAR}),'%')
            </if>
        </if>
        <if test='params != null and params.size > 0'>
            AND
            <foreach collection="params" item="param" open="(" separator=" OR " close=")">
                (dp.`name` LIKE CONCAT(CONCAT('%', #{param, jdbcType=VARCHAR}),'%')
                OR dav.version LIKE CONCAT(CONCAT('%', #{param, jdbcType=VARCHAR}),'%')
                OR dp.ip LIKE CONCAT(CONCAT('%', #{param, jdbcType=VARCHAR}),'%')
                OR dp.is_ready LIKE CONCAT(CONCAT('%', #{param, jdbcType=VARCHAR}),'%')
                OR dai.`code` LIKE CONCAT(CONCAT('%', #{param, jdbcType=VARCHAR}),'%')
                )
            </foreach>
        </if>
    </sql>

    <select id="listAppServicePod" resultType="io.choerodon.devops.infra.dto.DevopsEnvPodDTO">
        SELECT
        dp.id,
        dp.ip,
        project.iam_project_id projectId,
        dam.share_level,
        dp.`name`,
        dp.instance_id,
        dp.namespace namespace,
        dp.is_ready,
        dp.`status`,
        dp.creation_date,
        da.`name` appServiceName,
        dav.version appServiceVersion,
        dai.`code` instanceCode,
        de.id envId,
        de.`code` envCode,
        de.`name` envName,
        dp.object_version_number
        FROM
        devops_env_pod dp
        JOIN devops_app_service_instance dai ON dp.instance_id = dai.id
        JOIN devops_app_service_version dav ON dai.app_service_version_id = dav.id
        JOIN devops_app_service da ON dav.app_service_id = da.id
        JOIN devops_env de ON de.id = dai.env_id
        LEFT JOIN devops_app_service_share_rule dam on dam.app_service_id = da.id
        LEFT JOIN devops_project project ON da.app_id = project.app_id
        WHERE de.project_id = #{projectId}
        <if test='appServiceId != null'>
            AND da.id= #{appServiceId}
        </if>
        <if test='instanceId != null'>
            AND dai.id= #{instanceId}
        </if>
        <if test='envId != null'>
            AND de.id= #{envId}
        </if>
        <include refid="sqlparam"/>
    </select>

    <select id="queryEnvPodIns" resultType="io.choerodon.devops.api.vo.DevopsEnvPodInfoVO">
        SELECT dep.name name, ins.code instance_name, dep.creation_date, dep.namespace
        FROM devops_env_pod dep
                 INNER JOIN devops_app_service_instance ins ON dep.instance_id = ins.id
                 INNER JOIN devops_env de ON dep.namespace = de.code
        WHERE ins.env_id = #{envId}
    </select>

    <select id="queryPodByEnvIdAndInstanceId" resultType="io.choerodon.devops.infra.dto.DevopsEnvPodDTO">
        SELECT dep.id, dep.name, derd.message, dep.creation_date
        FROM devops_env_pod dep
                 JOIN devops_env_resource der ON der.instance_id = dep.instance_id
                 JOIN devops_env_resource_detail derd ON der.resource_detail_id = derd.id
        WHERE der.instance_id = #{instanceId}
          AND der.env_id = #{envId}
          AND der.kind = 'Pod'
          AND dep.name = der.name
    </select>
</mapper>
